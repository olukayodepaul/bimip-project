syntax = "proto3";

package bimip;

// ---------------- Identity ----------------
message Identity {
  string eid = 1;                              // User’s global identifier (e.g., account ID or JID)
  optional string connection_resource_id = 2;  // Identifier for a specific device or session instance
  optional string node = 3;                             // System node handling this entity (cluster context)
}

// ---------------- Media ----------------
message Media {
  string type = 1;         // "image" | "video" | "audio" | "file"
  string url = 2;          // URL of the media
  string thumbnail = 3;    // Thumbnail URL (optional)
  int64 size = 4;          // Size in bytes
}


// ---------------- Awareness ----------------
message Awareness {
  string id = 1;
  Identity from = 2;
  Identity to = 3;
  int32 type = 4;
  int32 status = 5;
  int32 location_sharing = 6;
  double latitude = 7;
  double longitude = 8;
  int32 ttl = 9;
  string details = 10;
  int64 timestamp = 11;
  int32 visibility = 12;
}

message SignalAckState {
  bool send = 1;
  bool received = 2;
  bool read = 3;
}

// ---------------- Message ----------------
// Represents a chat or notification message between users.
// Message-level ACKs are tracked via the status field.
// Awareness (TYPING, RECORDING) is per-user and handled separately.
// This is sent once.
message Message {
  string id = 1;               // client/queue-generated message ID
  int32 signal_offset = 2;     // server-assigned global ID (monotonic or unique)
  int32 user_offset = 3;       // server-assigned global ID (monotonic or unique)
  Identity from = 4;           // sender (JID or user ID)
  Identity to = 5;             // recipient (JID or user ID)
  int64 timestamp = 7;         // epoch milliseconds
  bytes payload = 8;           // pass JSON { }
  string encryption_type = 9;  // "none", "AES256", "E2E", etc.
  string encrypted = 10;       // base64 encrypted content (if any)
  string signature = 11;                      // base64 signature for integrity 
  int32 signal_type = 12;                     // 1=SENDER  2=DEVICE  3=RECEIVER
  bool signal_offset_state = 13;            // 
  SignalAckState signal_ack_state = 14;     //
}

// when Device receive sent ack. it update the local message with 
// signal_offset and user_offset.

// -------------------------------------------------------------
// status defines the real-time user activity or system state
// -------------------------------------------------------------
// 1 = CHATING        → User is actively chatting
// 2 = RECORDING      → User is recording audio/video
// 3 = PLAYED/VIEWED  → Media or message has been viewed/played
// 4 = TYPING         → User is typing
// 5 = PAUSED         → Typing/recording paused
// 6 = CANCELLED      → Action cancelled
// 7 = RESUME         → Action resumed
// 8 = NOTIFICATION   → System/app notification (non-chat event)
// -------------------------------------------------------------
// ---------------- Signal ----------------
// Used by both client and server to reconcile message status.
// Supports dual reference (id + signal_id) for precise synchronization.
message Signal {
  string id = 1;            // client/queue message ID
  int32 signal_offset = 2; // server-assigned global ID (monotonic or unique)
  int32 user_offset = 3;   // server-assigned global ID (monotonic or unique)
  int32 status = 4;     
  int64 timestamp = 5;      // epoch ms
  Identity from = 6;        // who sent the ACK
  Identity to = 7;          // who receives the ACK
  int32 type = 8;           // 1=REQUEST, 2=RESPONSE, 3=ERROR
  int32 signal_type = 9;    // 1=SENDER  2=DEVICE  3=RECEIVER
  optional string error = 10;// optional error message if type=3
  bool signal_offset_state = 11 ;   // use to forward offset.
  SignalAckState signal_ack_state = 12;     //
}

// ---------------- PushNotification ----------------
message PushNotification {
  string id = 1;
  Identity from = 2;
  Identity to = 3;
  string type = 4;
  int64 timestamp = 5;
  bytes payload = 6;
}

// ---------------- ErrorMessage ----------------
message ErrorMessage {
  int32 code = 1;
  int32 error_origin = 2;
  string details = 3;
  int64 timestamp = 4;
}

// ---------------- PingPong ----------------
message PingPong {
  string id = 1;
  Identity from = 2;
  int32 type = 3;
  int64 timestamp = 4;
  string details = 5;
}

// ---------------- Contact ----------------
message Contact {
  Identity from = 1;
  Identity to = 2;
  string tracking_id = 3;
  int32 relationship = 4;
  int32 action = 5;
  int64 timestamp = 6;
  string details = 7;
}

// ---------------- AwarenessVisibility ----------------
message AwarenessVisibility {
  string id = 1;
  Identity from = 2;
  int32 type = 3;
  int64 timestamp = 4;
  string details = 5;
}

// ---------------- TokenAuthority ----------------
message TokenAuthority {
  Identity to = 1;
  string token = 2;
  int32 type = 3;
  int32 task = 4;
  int64 timestamp = 5;
  string details = 6;
}

// ---------------- LocationStream ----------------
message LocationStream {
  string id = 1;
  Identity from = 2;
  Identity to = 3;
  double latitude = 4;
  double longitude = 5;
  optional double altitude = 6;
  int64 timestamp = 7;
}

// ---------------- Logout ----------------
message Logout {
  Identity to = 1;
  int32 type = 2;
  int32 status = 3;
  int64 timestamp = 4;
  string details = 5;
}

// ---------------- Body ----------------
message Body {
  int64 route = 1;
  repeated Awareness awareness_list = 2;
  repeated Message message = 3;
  int64 timestamp = 4;
}

// ---------------- MessageScheme ----------------
message MessageScheme {
  int64 route = 1;
  oneof payload {
    Awareness awareness = 2;
    PingPong ping_pong = 3;
    AwarenessVisibility awareness_visibility = 4;
    TokenAuthority token_authority = 5;
    Message message = 6;
    Signal signal = 7;
    PushNotification push_notification = 8;
    LocationStream location_stream = 9;
    Body body = 10;
    ErrorMessage error = 11;
    Logout logout = 12;
  }
}



